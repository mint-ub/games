<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Granny-source</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    
    <style>

      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
      }
      .webgl-content, #gameContainer {
        width: 100% !important;
        height: 100% !important;
      }

      .footer {
        display: none !important;
      }
    </style>

    <script src="TemplateData/UnityProgress.js"></script>  
    <script src="Build/UnityLoader.js"></script>
    <script>
      const totalDataChunks = 16;
      const dataBaseUrl = "Build/granni.data.unityweb.";

      async function fetchWithProgress(url) {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`Failed to fetch ${url}`);
          const reader = response.body.getReader();
          let chunks = [];
          let received = 0;
          while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              received += value.length;
              chunks.push(value);
          }
          let fullBuffer = new Uint8Array(received);
          let offset = 0;
          for (let chunk of chunks) {
              fullBuffer.set(chunk, offset);
              offset += chunk.length;
          }
          return fullBuffer.buffer;
      }

      async function startLoading() {
          try {
              let partUrls = [];
              for (let i = 1; i <= totalDataChunks; i++) {
                  partUrls.push(dataBaseUrl + i);
              }

              const buffers = await Promise.all(partUrls.map(url => fetchWithProgress(url)));
              const mergedBlob = new Blob(buffers, { type: "application/octet-stream" });
              const mergedDataUrl = URL.createObjectURL(mergedBlob);
              
              // Instantiate Unity and point to the merged blob
              var gameInstance = UnityLoader.instantiate("gameContainer", "Build/granni.json", {
                  onProgress: UnityProgress,
                  Module: {
                      dataUrl: mergedDataUrl,
                      locateFile: function(path) {
                          if (path.endsWith(".data.unityweb")) return mergedDataUrl;
                          return "Build/" + path;
                      }
                  }
              });


              window.addEventListener('resize', () => {
                  if (gameInstance) {

                      document.getElementById("gameContainer").style.width = window.innerWidth + "px";
                      document.getElementById("gameContainer").style.height = window.innerHeight + "px";
                  }
              });

          } catch (err) {
              console.error("Assembly Error:", err);
          }
      }

      startLoading();
    </script>
  </head>
  <body>
    <div class="webgl-content">
      <div id="gameContainer"></div>
    </div>
  </body>
</html>